import streamlit as st
import pandas as pd
import requests
import time
import re
import urllib.parse
from datetime import datetime, date
import plotly.express as px
from bs4 import BeautifulSoup
import gspread
from oauth2client.service_account import ServiceAccountCredentials

# --- 1. SAYFA VE TASARIM AYARLARI ---
st.set_page_config(
    page_title="Lojistik Pro",
    page_icon="ğŸš›",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# --- 2. Ã–ZEL CSS ---
def local_css():
    st.markdown("""
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        html, body, [class*="css"] {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .main-header {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e3a8a;
            text-align: center;
            margin-bottom: 20px;
        }
        .stButton>button {
            border-radius: 12px;
            font-weight: 600;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            height: 50px;
        }
        .stButton>button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }
        div[data-testid="stMetric"] {
            background-color: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }
        #MainMenu {visibility: hidden;}
        footer {visibility: hidden;}
        header {visibility: hidden;}
    </style>
    """, unsafe_allow_html=True)

local_css()

# --- SABÄ°TLER ---
SHEET_ADI = "Lojistik_Verileri"
# Kendi API AnahtarÄ±nÄ± buraya yapÄ±ÅŸtÄ±r:
API_KEY = "BURAYA_API_KEYINI_YAPISTIR" 

# --- ARAMA KATEGORÄ°LERÄ° ---
SEKTORLER = {
    "ğŸš› Lojistik": "Lojistik FirmalarÄ±",
    "ğŸ“¦ Nakliye": "Yurt Ä°Ã§i Nakliye FirmalarÄ±",
    "ğŸŒ UluslararasÄ±": "UluslararasÄ± Transport",
    "ğŸ¤ Kooperatifler": "Kamyoncular Kooperatifi",
    "ğŸ­ Fabrikalar (OSB)": "Organize Sanayi BÃ¶lgesi FabrikalarÄ±",
    "ğŸšŒ Servis/Turizm": "Personel TaÅŸÄ±macÄ±lÄ±ÄŸÄ±",
    "ğŸ—ï¸ Ä°nÅŸaat": "Ä°nÅŸaat Malzemeleri ToptancÄ±larÄ±",
    "ğŸ¥ SaÄŸlÄ±k/Rehab": "Ã–zel EÄŸitim ve Rehabilitasyon",
    "ğŸ¥• GÄ±da ToptancÄ±": "GÄ±da ToptancÄ±larÄ±"
}

# --- GOOGLE SHEETS BAÄLANTISI ---
def get_google_sheet_client():
    scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
    creds_dict = dict(st.secrets["gcp_service_account"])
    if "info" in creds_dict:
        import json
        creds_dict = json.loads(creds_dict["info"])
    creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
    client = gspread.authorize(creds)
    return client

@st.cache_data(ttl=10)
def veri_tabanini_yukle():
    try:
        client = get_google_sheet_client()
        sheet = client.open(SHEET_ADI).sheet1
        data = sheet.get_all_records()
        
        beklenen_sutunlar = ["Firma", "Telefon", "Web", "Email", "Adres", "Durum", "Notlar", "Sozlesme_Tarihi", "Hatirlatici_Tarih"]
        
        if not data:
            sheet.append_row(beklenen_sutunlar)
            return pd.DataFrame(columns=beklenen_sutunlar)
            
        df = pd.DataFrame(data)
        
        for col in beklenen_sutunlar:
            if col not in df.columns:
                df[col] = ""
        
        text_cols = ["Notlar", "Telefon", "Tuketim_Bilgisi", "Firma", "Adres", "Durum", "Web", "Email"]
        for col in text_cols:
            if col in df.columns:
                df[col] = df[col].astype(str).replace("nan", "").replace("None", "")
        
        for col in ["Hatirlatici_Tarih", "Sozlesme_Tarihi"]:
            if col in df.columns:
                df[col] = pd.to_datetime(df[col], errors='coerce')
                
        return df
    except Exception as e:
        st.error(f"Veri yÃ¼kleme hatasÄ±: {e}")
        return pd.DataFrame(columns=["Firma", "Telefon", "Web", "Email", "Adres", "Durum", "Notlar", "Sozlesme_Tarihi", "Hatirlatici_Tarih"])

def veriyi_kaydet(df):
    try:
        client = get_google_sheet_client()
        sheet = client.open(SHEET_ADI).sheet1
        df_save = df.copy()
